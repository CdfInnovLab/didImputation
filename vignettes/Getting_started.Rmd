---
title: "Getting started"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting_started}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

require(data.table)
require(ggplot2)
require(cowplot)
```

This package implements the imputation method developed by [Borusyak, Jaravel, and Spiess (2021)](https://uc5e4d5690cad8b63971f502beb3.dl.dropboxusercontent.com/cd/0/inline2/BTx5o7zNQteCIGa70QjOyslQ0p4DfhWhhY0TECO5mGPb_od1TbF97sfxQAm1P8GmDRtB3z8Sl4ayj_wk_HTDWXRNqElY6ARDcU8-98VK3YjZBDXh3CLVqx8cey4F-75YLZiBOZIy_rNvqUoR6I3g9Nozlm0oSww1UYMxefXQcewYB4CdPgIiFoZnNX4E79riQWYZF1VsfJbWyAVf8RMAGtLUcpXI7ATJXVsH58SUWzAACHyZgeIuZX9Ge7-0d0izDDe_JV-hJVN6zPvzkAjg787UX6JIwRRGeeovW8hEAtqzn21KCRvHwVwtVgXd3qBozo8XApe-PFKVeHOLkv4eCz-1kLkLyEVIws6l49nvolWa0-6VRyvyEOuyTxOgBy8TwbM/file) for staggered difference-in-differences. It allows for constant or dynamic treatment effects, among others. The following presentation highlights the main features available using a simple example. Note that this package is a wrapper around the following packages: `r collapse`, `r data.table` and `r fixest`. It allows us a highly efficient estimation procedure, even with large and complex datasets. We will use `r data.table` in the following example, but it is not compulsory to provide a dataset in this format to the estimation function.

# A simple example 

## Generating simulated data

To show how to use the package, we will generate a simple dataset similar to the one used in the original paper. Let's first load the package:

```{r setup}
library(didImputation)
```

The custom function `r generateDidData` is directly available to generate simulated data. The setup is as follows:

- 10000 units $i$ observed over 6 periods $t$.
- Units are randomly treated starting period 2 and some unit are never treated (`r Inf` values). This information is summarized in $g_{it}$, representing the treatment group. The next step consists in defining the relative time to treatment-or horizon-$k_{it} = t-g$. For example, $k_{it} = 0$ means that unit $i$ is treated for the first time in period $t$.
- Treatment effects $\tau_{it}$ vary by horizon, with $\tau_{it} = k_{it} + 1$ for treated observations.
- We assume a linear data generating process: $Y_{it} = \alpha_i + \beta_t + \tau_{it} + \varepsilon_{it}$, where $\alpha_i$ are unit fixed-effects, $\beta_t$ are time fixed-effects and $\varepsilon_{it} \sim \mathcal{N}(0,1)$ are iid error terms.

```{r}
data <- generateDidData(i = 10000,
                        t = 6,
                        hdfe = FALSE,
                        control = FALSE,
                        treatment = ~ d * (k + 1))

setDT(data)
```

Two implications are worth noting. They have been emphasized by the recent literature on staggered designs and are not specific to our setup.

- Nobody is treated in the first period: we need at least one period for which a unit is not treated in order to impute the given unit fixed-effect.
- Some observations remain untreated in the last period. We cannot impute the time fixed-effect for a period where everybody is treated.

Let's plot the true treatment effects over time for each treatment group:

```{r}
agg <- data[, 
            .(trueffect = mean(trueffect)),
            by = .(t, g)]

ggplot(agg, aes(x = t, y = trueffect, color = as.factor(g))) +
  geom_line() +
  geom_point() +
  labs(x = "Period", y = "True effect", color = "Treatment group") +
  scale_x_continuous(breaks = seq(1, 6)) +
  theme_half_open() +
  background_grid() + 
  theme(legend.position = "bottom")
```

## Estimation procedure

The `r didImputation` function estimates treatment effects. It allows for static and dynamic treatment effects (by horizon). Let's review some main arguments and options of this function.

- `r y0` is the counterfactual formula, i.e the formula under no treatment. It follows the `r fixest` syntax: fixed-effects are inserted after the `r |`. See the online [documentation](https://cran.r-project.org/web/packages/fixest/vignettes/fixest_walkthrough.html) for further details. We add a 0 as the first argument on the right hand side to exclude the intercept from the estimation.
- `r data` is the dataset used for the estimation.
- `r cohort` is the treatment group, in our case the treatment period.
- `r unit` is the variable containing unit of observation identifiers. By default, it takes the first fixed-effect from the formula.
- `r time` is the variable containing period of observation identifiers. By default, it takes the second fixed-effect from the formula.
- `r coef` are the treatment coefficients to be estimated, given as a sequence. By default, it estimates the fully dynamic model with the maximum number of leads and lags. Note that for pre-trends, the omitted periods are the most distant ones. See below if you want to estimate the static treatment effect.

```{r}
est <- didImputation(y0 = y ~ 0 | i + t,
                     data = data,
                     cohort = "g",
                     nevertreated.value = Inf,
                     unit = "i",
                     time = "t",
                     coef = -Inf:Inf)
```

The `r summary` method reports the results from the estimation:

```{r}
summary(est)
```

The coefficient table is also directly accessible as a `r data.table`:

```{r}
est$coeftable
```

Finally, we can plot the coefficients from the fully dynamic model using the `r didplot` function (note that you can choose the confidence interval level to report). The results are very close to the true effects:

```{r}
didplot(est) +
  geom_point(aes(y = c(0, 0, 0, 1, 2, 3, 4, 5)), color = "red", shape = 20, size = 2)
```

## Static treatment effect

The `r didImputation` function allows for static treatment effects through the r`OATT` argument. When set equal to r`TRUE`, the estimation reports the static coefficient and the pre-trends coefficient from the r`coef` argument:

```{r}
static <- didImputation(y0 = y ~ 0 | i + t,
                     data = data,
                     cohort = "g",
                     nevertreated.value = Inf,
                     unit = "i",
                     time = "t",
                     coef = -Inf:Inf,
                     OATT = TRUE)

summary(static)
```

## Including other fixed-effects

Additional fixed-effects can be directly included in the formula after the `r |`. Lets generate a dataset with a high-dimensional fixed-effects variable and estimate the model:

```{r}
# generate data with hdfe
data <- generateDidData(i = 10000,
                        t = 6,
                        hdfe = TRUE,
                        control = FALSE,
                        treatment = ~ d * (k + 1))

setDT(data)

# fully dynamic estimation
est <- didImputation(y0 = y ~ 0 | i + t + hdfefactor,
                     data = data,
                     cohort = "g",
                     nevertreated.value = Inf,
                     unit = "i",
                     time = "t",
                     coef = -Inf:Inf)

summary(est)
```

## Including continuous controls

Additional continuous controls can be directly included in the formula before the `r |`. Lets generate a dataset with such control and estimate the model:

```{r}
# generate data with hdfe
data <- generateDidData(i = 10000,
                        t = 10,
                        hdfe = FALSE,
                        control = TRUE,
                        treatment = ~ d * (k + 1))

setDT(data)

# fully dynamic estimation
est <- didImputation(y0 = y ~ 0 + x1 | i + t,
                     data = data,
                     cohort = "g",
                     nevertreated.value = Inf,
                     unit = "i",
                     time = "t",
                     coef = -Inf:Inf)

summary(est)
```

# Additional features

## Sample weights

Sample weights can be used by passing the variable in the `r w` argument.

## Standard errors

The standard errors are computed using an alternating projection method. You can tweek its meta-parameter by changing `r tol` and `r maxit`. To speed up the estimation procedure, you can set `r with.se = FALSE`. Standard errors will not be computed in this case.

## Effective sample size

Borusyak, K., Jaravel, X., & Spiess, J. give a condition on weights such that consistency of estimators holds. This condition states that the Herfindahl index of weights must converge to zero. Another interpretation is that the inverse of the index is a measure of 'effective sample size'. Authors recommand an effective sample size of at least 30. If the effective sample size is lower, a warning will be thrown. You can tweek this parameter by changing `r effective.sample`.
